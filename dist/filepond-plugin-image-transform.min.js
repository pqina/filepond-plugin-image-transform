/*
 * FilePondPluginImageTransform 2.0.0
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FilePondPluginImageTransform=e()}(this,function(){"use strict";var t=function(t){return/^image/.test(t.type)},e=(function(){function t(t){this.value=t}function e(e){function n(t,e){return new Promise(function(n,a){var u={key:t,arg:e,resolve:n,reject:a,next:null};o?o=o.next=u:(i=o=u,r(t,e))})}function r(n,i){try{var o=e[n](i),u=o.value;u instanceof t?Promise.resolve(u.value).then(function(t){r("next",t)},function(t){r("throw",t)}):a(o.done?"return":"normal",o.value)}catch(h){a("throw",h)}}function a(t,e){switch(t){case"return":i.resolve({value:e,done:!0});break;case"throw":i.reject(e);break;default:i.resolve({value:e,done:!1})}i=i.next,i?r(i.key,i.arg):o=null}var i,o;this._invoke=n,"function"!=typeof e["return"]&&(this["return"]=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype["throw"]=function(t){return this._invoke("throw",t)},e.prototype["return"]=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new e(t.apply(this,arguments))}},await:function(e){return new t(e)}}}(),function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}),n={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},r=function(t,r,a,i){i!==-1&&t.transform.apply(t,e(n[i](r,a)))},a=function(t,e,n){e||(e={x:0,y:0,width:1,height:1});var a=document.createElement("canvas"),i=t.naturalWidth,o=t.naturalHeight;n>=5&&n<=8?(a.width=o,a.height=i):(a.width=i,a.height=o);var u=a.getContext("2d");u.save(),r(u,i,o,n),u.drawImage(t,0,0,i,o),u.restore();var h=u.getImageData(Math.round(e.x*a.width),Math.round(e.y*a.height),Math.round(e.width*a.width),Math.round(e.height*a.height));return h},i=function(t,e){return new Promise(function(n,r){var a=document.createElement("canvas");a.width=t.width,a.height=t.height;var i=a.getContext("2d");i.putImageData(t,0,0),a.toBlob(n,e.type,e.quality)})},o=function(t){var e=void 0;try{e=new ImageData(t.width,t.height)}catch(n){var r=document.createElement("canvas");e=r.getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},u=function(){function t(t,e){var n=e.mode,r=e.upscale,a=e.size,i=a.width,o=a.height;if(null===i?i=o:null===o&&(o=i),"force"!==n){var u=i/t.width,h=o/t.height,c=1;if("cover"===n?c=Math.max(u,h):"contain"===n&&(c=Math.min(u,h)),c>1&&r===!1)return t;i=t.width*c,o=t.height*c}for(var l=t.width,f=t.height,s=Math.round(i),d=Math.round(o),g=t.data,v=new Uint8ClampedArray(s*d*4),m=l/s,p=f/d,y=Math.ceil(m/2),w=Math.ceil(p/2),x=0;x<d;x++)for(var M=0;M<s;M++){for(var b=4*(M+x*s),T=0,_=0,A=0,E=gx_g=gx_b=gx_a=0,I=(x+.5)*p,F=Math.floor(x*p);F<(x+1)*p;F++)for(var R=Math.abs(I-(F+.5))/w,U=(M+.5)*m,O=R*R,P=Math.floor(M*m);P<(M+1)*m;P++){var L=Math.abs(U-(P+.5))/y,B=Math.sqrt(O+L*L);B>=-1&&B<=1&&(T=2*B*B*B-3*B*B+1,T>0&&(L=4*(P+F*l),gx_a+=T*g[L+3],A+=T,g[L+3]<255&&(T=T*g[L+3]/250),E+=T*g[L],gx_g+=T*g[L+1],gx_b+=T*g[L+2],_+=T))}v[b]=E/_,v[b+1]=gx_g/_,v[b+2]=gx_b/_,v[b+3]=gx_a/A}return{data:v,width:s,height:d}}var e={resize:t},n=function(t,n){return t.forEach(function(t){n=e[t.type](n,t.data)}),n},r=function(t,e){var r=n(t.transforms,t.imageData);e(r)};self.onmessage=function(t){r(t.data.message,function(e){self.postMessage({id:t.data.id,message:e},[e.data.buffer])})}};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){var r=this;setTimeout(function(){for(var a=r.toDataURL(e,n).split(",")[1],i=atob(a),o=i.length,u=new Uint8Array(o);o--;)u[o]=i.charCodeAt(o);t(new Blob([u],{type:e||"image/png"}))})}});var h=function(e){var n=e.addFilter,r=e.utils,h=r.Type,c=r.forin,l=r.loadImage,f=r.getFileFromBlob,s=r.getFilenameWithoutExtension,d=r.createWorker,g=r.createBlob,v=r.renameFile,m=r.isFile,p=function(t,e){var n=s(t),r="image/jpeg"===e?"jpg":e.split("/")[1];return n+"."+r},y=function(t){return"image/jpeg"===t||"image/png"===t?t:"image/jpeg"},w=["resize"];return n("PREPARE_OUTPUT",function(e,n){var r=n.query,h=n.item;return new Promise(function(n,s){if(!m(e)||!t(e)||!r("GET_ALLOW_IMAGE_TRANSFORM"))return n(e);var x=r("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),M=null===x?null:x/100,b=r("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),T=h.getMetadata(),_=T.crop,A=[];if(c(h.getMetadata(),function(t,e){w.includes(t)&&A.push({type:t,data:e})}),null===M&&null===b&&!_&&!A.length)return n(e);var E=function(t,r){i(t,r).then(function(t){var r=f(t,p(e.name,y(t.type)));n(r)})["catch"](function(t){console.error(t)})},I=URL.createObjectURL(e);if(/svg/.test(e.type)&&null===b){if(!_)return n(e);var F=new FileReader;return F.onloadend=function(){var t=document.createElement("div");t.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",t.innerHTML=F.result;var r=t.querySelector("svg");document.body.appendChild(t);var a=r.getBBox();t.parentNode.removeChild(t);var i=r.getAttribute("viewBox")||"",o=r.getAttribute("width")||"",u=r.getAttribute("height")||"",h=parseFloat(o)||null,c=parseFloat(u)||null,l=(o.match(/[a-z]+/)||[])[0]||"",f=(u.match(/[a-z]+/)||[])[0]||"";r.removeAttribute("width"),r.removeAttribute("height");var s=r.outerHTML,d=i.split(" ").map(parseFloat),m=d.length?{x:d[0],y:d[1],width:d[2],height:d[3]}:a;h||(h=m.width),c||(c=m.height);var p='width="'+h*_.rect.width+l+'"',y='height="'+c*_.rect.height+f+'"',w={x:h*-_.rect.x,y:c*-_.rect.y},x='<?xml version="1.0" encoding="UTF-8"?>\n<svg '+p+" "+y+' \n  viewBox="0 0 '+h+" "+c+'" \n  preserveAspectRatio="xMinYMin slice"\n  xmlns="http://www.w3.org/2000/svg">\n  <g transform="translate('+w.x+", "+w.y+')">\n    '+s+"\n  </g>\n</svg>";n(v(g(x,"image/svg+xml"),e.name))},void F.readAsText(e)}l(I).then(function(t){URL.revokeObjectURL(I);var n=(h.getMetadata("exif")||{}).orientation||-1,r=a(t,_?_.rect:null,n);if(!A.length)return void E(r,{quality:M,type:b||e.type});var i=d(u);i.post({transforms:A,imageData:r},function(t){E(o(t),{quality:M,type:b||e.type}),i.terminate()},[r.data.buffer])})})}),{options:{allowImageTransform:[!0,h.BOOLEAN],imageTransformOutputMimeType:[null,h.STRING],imageTransformOutputQuality:[null,h.INT]}}};return"undefined"!=typeof navigator&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:h})),h});